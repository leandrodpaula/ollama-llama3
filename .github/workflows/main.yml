name: CI/CD Ollama

on:
    push:
        branches:
        - main
    pull_request:
        branches:
        - main


jobs:
    build-and-push:
        runs-on: ubuntu-latest
        environment: hml
        env:
            ACTIONS_RUNNER_DEBUG: true  # Habilita o modo debug

        steps:
        - name: Checkout code
          uses: actions/checkout@v2
        
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1
        
        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_CREDENTIALS }}
        

        - name: Configure Docker to use gcloud as a credential helper
          run: |
              gcloud auth configure-docker
      
        - name: Build/Push Ollama
          run: |
              docker pull ollama/ollama:latest 
              docker tag ollama/ollama:latest gcr.io/${{ secrets.GCP_PROJECT_ID }}/ollama:latest
              docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/ollama:latest

        - name: Build/Push Open WebUI
          run: |
              docker pull ghcr.io/open-webui/open-webui:main
              docker tag ghcr.io/open-webui/open-webui:main gcr.io/${{ secrets.GCP_PROJECT_ID }}/open-webui:latest
              docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/open-webui:latest